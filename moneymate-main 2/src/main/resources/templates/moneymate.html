<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë…¸ë‘ê°€ê³„ë¶€ MoneyMate</title>

<style>
  :root{
    --y-50:#FFFAE5;
    --y-100:#FFF1B8;
    --y-200:#FFE680;
    --y-300:#FFD84D;
    --y-400:#FFC93A;
    --y-600:#CC9A00;
    --ink:#3B3B3B;
    --line:#E9E2B0;
    --white:#FFFFFF;
    --ok:#2E7D32;
    --warn:#C62828;
    --muted:#7A7A7A;
    --radius:16px;
    --shadow:0 6px 24px rgba(0,0,0,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Pretendard","Inter",system-ui,AppleSDGothicNeo,Segoe UI,Arial,sans-serif;
    color:var(--ink);
    background:var(--y-50);
  }
  a{color:inherit;text-decoration:none}
  button,input,select,textarea{font-family:inherit}

  .container{max-width:1100px;margin:0 auto;padding:24px}
  .page{display:none}
  .page.active{display:block}
  .card{
    background:var(--white);
    border-radius:var(--radius);
    padding:16px;
    border:1px solid var(--line);
    box-shadow:var(--shadow);
  }
  .btn{
    background:var(--y-300);
    color:#3b2f00;
    border:none;
    border-radius:12px;
    padding:10px 14px;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
  }
  .btn:hover{background:var(--y-400)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
  }
  .input, .select{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:white;
    font-size:14px;
  }
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  .hidden{display:none!important}

  /* Header */
  .header{
    position:sticky;
    top:0;
	z-index:20001;
    background:linear-gradient(180deg, var(--y-100), rgba(0,0,0,0));
    backdrop-filter:saturate(120%);
  }
  .header-wrap{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 24px;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
  .hamburger{
    width:36px;height:36px;border-radius:10px;border:1px solid var(--line);
    background:white;display:grid;place-items:center;cursor:pointer;
  }
  .hamburger i{
    display:block;width:18px;height:2px;background:var(--ink);position:relative;
  }
  .hamburger i:before,.hamburger i:after{
    content:"";position:absolute;left:0;width:18px;height:2px;background:var(--ink);
  }
  .hamburger i:before{top:-6px}
  .hamburger i:after{top:6px}

  .kpi{font-size:18px;font-weight:800}
  .muted{color:var(--muted);font-size:13px}

  /* Avatar & dropdown */
  .avatar{width:36px;height:36px;border-radius:50%;border:1px solid var(--line);background:linear-gradient(135deg,#fff,var(--y-100));display:grid;place-items:center;cursor:pointer}
  .dropdown{position:absolute;right:0;top:46px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:160px}
  .dropdown ul{list-style:none;margin:0;padding:6px}
  .dropdown li{padding:8px;border-radius:8px;cursor:pointer;font-size:14px}
  .dropdown li:hover{background:var(--y-50)}
  .dropdown.hidden{display:none}

  /* Sheet ë©”ë‰´ */
  .sheet{
    position:fixed;
    inset:0;
    display:none;
    z-index: 10000;   /* â­â­ ì¶”ê°€! ë©”ë‰´ì˜ ìµœìƒìœ„ ë ˆë²¨ë¡œ ì˜¬ë¦¼ */
  }
  .sheet.active{display:block}
  .sheet .backdrop{
    position:absolute;inset:0;background:rgba(0,0,0,.18);
  }
  .sheet .panel{
	padding-top: 60px !important; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
    position:absolute;left:0;top:0;bottom:0;width:300px;
    background:white;border-right:1px solid var(--line);
    padding:18px;display:flex;flex-direction:column;gap:16px;
    box-shadow:var(--shadow);
  }
  .menu-title{
    font-weight: 800;  /* ìˆì–´ë„ ë˜ê³  ì—†ì–´ë„ ë¨ */

    height: 56px;        /* ì´ê²Œ í•µì‹¬! ìœ„ì— ê³µê°„ í™•ë³´ */
    visibility: hidden;  /* ê¸€ìëŠ” ì•ˆ ë³´ì´ê²Œ */
  }


  .menu-group{display:flex;flex-direction:column;gap:8px}
  .menu-group button{width:100%;text-align:left;justify-content:flex-start}

  /* Switch */
  .switch{display:flex;align-items:center;gap:10px;font-size:13px}
  .switch input{appearance:none;width:44px;height:26px;background:#ddd;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .switch input:checked{background:var(--y-300)}
  .switch input:before{
    content:"";position:absolute;width:20px;height:20px;border-radius:50%;left:3px;top:3px;background:#fff;transition:.2s;
  }
  .switch input:checked:before{left:21px}

  /* Auth */
  .auth-wrap{max-width:420px;margin:40px auto;}
  .auth-logo{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px}
  .auth-logo i{width:34px;height:34px;border-radius:10px;background:var(--y-300);display:inline-block}
  .auth-tabs{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
  .auth-tabs button{flex:1}

  /* ë©”ì¸ */
  .grid{display:grid;grid-template-columns:1.4fr 1fr;gap:16px}
  .tile{padding:16px}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--line);background:white;
    font-size:13px;
  }

  /* í…Œì´ë¸” ê³µí†µ */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px;border-bottom:1px solid var(--line);font-size:13px}
  th{text-align:left;color:#5A4E00;background:rgba(255,249,190,0.4)}

  /* ìº˜ë¦°ë” */
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
  .day{
    min-height:90px;padding:8px;border-radius:10px;
    border:1px solid var(--line);
    background:white;display:flex;flex-direction:column;
  }
  .date{font-weight:700}
  .badge{
    display:inline-block;padding:2px 6px;border-radius:6px;
    background:var(--y-100);border:1px solid var(--line);font-size:11px
  }
  .tag-hi{background:#FFE0E0;border-color:#ffc7c7}
  .tag-lo{background:#E7FFE7;border-color:#c9f5c9}

  canvas{width:100%;height:260px}

  /* ê°•ì•„ì§€ */
  .dog-card{display:grid;grid-template-columns:1.1fr 1.1fr;gap:16px}
  .dog-left{position:relative;overflow:hidden;border-radius:var(--radius);background:linear-gradient(180deg,#FFF9D1,#FFF4A4)}
  .dog-img{
    position:absolute;
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    width:180px;
    height:180px;
    border-radius:50%;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    box-shadow:0 18px 40px rgba(0,0,0,.15);
  }
  @keyframes float{0%,100%{transform:translate(-50%,-50%) translateY(0)}50%{transform:translate(-50%,-50%) translateY(-10px)}}
  .bone{position:absolute;bottom:14px;left:14px;background:#fff;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-weight:700;font-size:13px}
  .dog-right{padding:16px;display:flex;flex-direction:column;gap:10px}
  .level-pill{display:inline-flex;gap:8px;align-items:center;background:var(--y-100);border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px}
  .progress{height:12px;background:#FFF5CC;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--y-300),#FFE072)}
  .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .actions button{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:13px;cursor:pointer}

  /* Toast */
  .toast{
    position:fixed;right:20px;bottom:20px;
    background:#2d3436;color:#fff;padding:10px 14px;
    border-radius:999px;font-size:13px;
    opacity:0;pointer-events:none;
    transform:translateY(8px);
    transition:opacity .2s,transform .2s;
  }
  .toast.show{opacity:1;pointer-events:auto;transform:translateY(0)}

  @media (max-width:900px){
    .grid{grid-template-columns:1fr}
    .dog-card{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-wrap container">
    <div class="brand">
      <div class="hamburger" id="openMenu" title="ë©”ë‰´ ì—´ê¸°"><i></i></div>
      <span>ë…¸ë‘ê°€ê³„ë¶€</span>
    </div>
    <div id="headerGreeting" class="kpi">ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš” ğŸ£</div>
    <div style="position:relative">
      <div class="avatar" id="avatarBtn" title="ê³„ì •"><span>ğŸ‘¤</span></div>
      <div class="dropdown hidden" id="avatarDropdown">
        <ul>
          <li id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</li>
        </ul>
      </div>
    </div>
  </div>
</header>

<!-- ì‚¬ì´ë“œ ì‹œíŠ¸ ë©”ë‰´ -->
<aside class="sheet" id="menuSheet" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="panel">
    <div class="menu-group">
      <div class="switch" title="KRW/AUD ì „ì²´ í†µí™” ì „í™˜ (í”„ë¡ íŠ¸ í‘œì‹œìš©)">
        <label for="currencyToggle">KRW â†”ï¸ AUD</label>
        <input type="checkbox" id="currencyToggle" />
      </div>
     <div style="font-size:12px;display:none" class="muted" id="rateInfo">* ì‹¤ì‹œê°„ í™˜ìœ¨: <span id="rateLabel">1 AUD = 900 KRW</span></div>
    </div>
    <div class="menu-group" aria-label="í˜ì´ì§€ ì´ë™">
      <button class="btn ghost" data-nav="page-main">ë©”ì¸</button>
      <button class="btn ghost" data-nav="page-budget">ì˜ˆì‚°</button>
      <button class="btn ghost" data-nav="page-expense">ì§€ì¶œë‚´ì—­</button>
      <button class="btn ghost" data-nav="page-calendar">ë‹¬ë ¥</button>
      <button class="btn ghost" data-nav="page-stats">í†µê³„</button>
      <button class="btn ghost" data-nav="page-dog">ê°•ì•„ì§€ í‚¤ìš°ê¸°</button>
	  <button class="btn ghost" data-nav="page-strategy">ì†Œë¹„ì „ëµ</button>
    </div>
  </div>
</aside>

<main class="container">

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
  <section id="page-auth" class="page active">
    <div class="auth-wrap card">
      <div class="auth-logo">
        <i></i><h1 style="margin:0;font-size:20px">ë…¸ë‘ê°€ê³„ë¶€</h1>
      </div>
      <p class="muted" style="margin-bottom:16px">
        ë¨¼ì € ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”. <br>
        ëª¨ë“  ë°ì´í„°ëŠ” ì„œë²„(DB)ì— ì €ì¥ë©ë‹ˆë‹¤.
      </p>
      <div class="auth-tabs">
        <button class="btn" id="tab-login">ë¡œê·¸ì¸</button>
        <button class="btn ghost" id="tab-signup">íšŒì›ê°€ì…</button>
      </div>

      <!-- ë¡œê·¸ì¸ -->
      <form id="login-form">
        <div class="row">
          <div class="col">
            <label>ì•„ì´ë””
              <input required class="input" id="login-username" placeholder="ì•„ì´ë””"/>
            </label>
          </div>
          <div class="col">
            <label>ë¹„ë°€ë²ˆí˜¸
              <input required type="password" class="input" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸"/>
            </label>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
          <button class="btn" type="submit">ë¡œê·¸ì¸</button>
        </div>
      </form>

      <!-- íšŒì›ê°€ì… -->
      <form id="register-form" class="hidden" style="margin-top:10px">
        <div class="row">
          <div class="col">
            <label>ì´ë¦„
              <input class="input" id="register-name" placeholder="ì´ë¦„"/>
            </label>
          </div>
          <div class="col">
            <label>ë‚˜ì´ (ì„ íƒ)
              <input type="number" min="1" class="input" id="register-age" placeholder="ì˜ˆ: 24"/>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>ì„±ë³„ (ì„ íƒ)
              <select class="select" id="register-gender">
                <option value="">ì„ íƒ ì—†ìŒ</option>
                <option value="FEMALE">ì—¬ì„±</option>
                <option value="MALE">ë‚¨ì„±</option>
                <option value="OTHER">ê¸°íƒ€</option>
              </select>
            </label>
          </div>
          <div class="col">
            <label>ì•„ì´ë””
              <input required class="input" id="register-username" placeholder="ì•„ì´ë””"/>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>ë¹„ë°€ë²ˆí˜¸
              <input required type="password" class="input" id="register-password" placeholder="ë¹„ë°€ë²ˆí˜¸"/>
            </label>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
          <button class="btn" type="submit">íšŒì›ê°€ì…</button>
        </div>
      </form>
    </div>
  </section>

  <!-- ë©”ì¸ -->
  <section id="page-main" class="page">
    <div class="grid">
      <div class="card tile" style="grid-column:1/3">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <h2 style="margin:0;font-size:18px">
            <span id="main-username">OOO</span>ë‹˜ì˜
            <span id="main-year-month">-</span> ì˜ˆì‚°ì€
            <span id="main-total-budget">0ì›</span> ì´ê³ ,
            í˜„ì¬ ì§€ì¶œì€ <span id="main-expense-total">0ì›</span> ì…ë‹ˆë‹¤.
          </h2>
          <div class="pill">
            ê¸°ì¤€ ì›”:
            <input type="month" id="global-year-month" class="input" style="width:130px;padding:4px 8px;font-size:12px" />
            <button class="btn ghost" id="btn-set-month" type="button" style="padding:4px 8px;font-size:12px;margin-left:4px">ì ìš©</button>
          </div>
        </div>
        <p class="muted" style="margin-top:6px">
          ê¸°ì¤€ ì›”ì€ ì˜ˆì‚°Â·ì§€ì¶œÂ·ë‹¬ë ¥Â·í†µê³„ í˜ì´ì§€ì— ê³µí†µìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
        </p>
      </div>

      <div class="card tile">
        <h3 style="margin-top:0">ì´ë²ˆ ë‹¬ ì†Œë¹„ íŒŒì´ì°¨íŠ¸</h3>
        <canvas id="pieChart" width="600" height="260" aria-label="ì†Œë¹„ íŒŒì´ì°¨íŠ¸"></canvas>
        <div class="muted" style="font-size:12px;margin-top:6px">ì‹ë¹„ / ì¹´í˜ / ì‡¼í•‘ / êµí†µë¹„ / ë¬¸í™” / ìƒí™œ / ê±´ê°• / ë·°í‹° ê¸°ì¤€</div>
      </div>

      <div class="card tile" style="display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h3 style="margin-top:0">ê°•ì•„ì§€ í‚¤ìš°ê¸°</h3>
          <p class="muted">ì§€ì¶œì„ ê¸°ë¡í•˜ë©´, ê°•ì•„ì§€ì—ê²Œ ë” ë§ì€ ë¼ˆë‹¤ê·€ë¥¼ ì¤„ ìˆ˜ ìˆì–´ìš” ğŸ¦´</p>
        </div>
        <div style="display:flex;align-items:center;gap:12px;font-size:40px">
          <span>ğŸ¶</span><span>ï¼‹</span><span>ğŸ¦´</span>
        </div>
        <div style="display:flex;justify-content:flex-end">
          <button class="btn" data-nav="page-dog">ê°•ì•„ì§€ í˜ì´ì§€ë¡œ ê°€ê¸° â†’</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ì˜ˆì‚° í˜ì´ì§€ -->
  <section id="page-budget" class="page">
    <div class="card tile">
      <h2>ê¸°ì¤€ ì›” ì„ íƒ</h2>
      <div class="row" style="align-items:flex-end">
        <div class="col">
          <label>ê¸°ì¤€ ì›”
            <input type="month" id="budget-year-month" class="input" />
          </label>
        </div>
        <div class="col" style="max-width:160px">
          <button class="btn" id="btn-budget-set-month" type="button">ì´ ë‹¬ ê¸°ì¤€ìœ¼ë¡œ ë³´ê¸°</button>
        </div>
      </div>
      <p class="muted" style="margin-top:6px">ê¸°ì¤€ ì›”ì€ ìƒë‹¨ ë©”ì¸ì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="card tile" style="margin-top:16px">
      <h2>ì´ ì˜ˆì‚° & ì¹´í…Œê³ ë¦¬ë³„ ì˜ˆì‚°</h2>
      <div class="row">
        <div class="col">
          <label>ì´ ì˜ˆì‚° (ì›)
            <input type="number" id="budget-total" class="input" placeholder="ì˜ˆ: 500000"/>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>ì‹ë¹„
            <input type="number" id="budget-food" class="input" placeholder="ì˜ˆ: 150000"/>
          </label>
        </div>
        <div class="col">
          <label>ì¹´í˜/ê°„ì‹
            <input type="number" id="budget-cafe" class="input" placeholder="ì˜ˆ: 50000"/>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>ì‡¼í•‘
            <input type="number" id="budget-shopping" class="input" placeholder="ì˜ˆ: 100000"/>
          </label>
        </div>
        <div class="col">
          <label>êµí†µë¹„
            <input type="number" id="budget-transport" class="input" placeholder="ì˜ˆ: 40000"/>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>ë¬¸í™”/ì—¬ê°€
            <input type="number" id="budget-culture" class="input" placeholder="ì˜ˆ: 30000"/>
          </label>
        </div>
        <div class="col">
          <label>ìƒí™œ/ê¸°íƒ€
            <input type="number" id="budget-life" class="input" placeholder="ì˜ˆ: 20000"/>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>ê±´ê°•/ìš´ë™
            <input type="number" id="budget-health" class="input" placeholder="ì˜ˆ: 20000"/>
          </label>
        </div>
        <div class="col">
          <label>ë·°í‹°/í—¤ì–´
            <input type="number" id="budget-beauty" class="input" placeholder="ì˜ˆ: 30000"/>
          </label>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
        <button class="btn" id="btn-save-budget" type="button">ì˜ˆì‚° ì €ì¥</button>
        <button class="btn ghost" id="btn-load-budget" type="button">ì˜ˆì‚° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn ghost" id="btn-delete-budget" type="button" style="color:#fff;background:#d63031;border:none">ì˜ˆì‚° ì‚­ì œ</button>
      </div>
    </div>
  </section>

  <!-- ì§€ì¶œ í˜ì´ì§€ -->
  <section id="page-expense" class="page">
    <div class="row">
      <div class="col">
        <div class="card tile">
          <h2>ì§€ì¶œ ì…ë ¥</h2>
          <div class="row">
            <div class="col">
              <label>ë‚ ì§œ
                <input type="date" id="expense-date" class="input"/>
              </label>
            </div>
            <div class="col">
              <label>ê¸ˆì•¡ (ì›)
                <input type="number" id="expense-amount" class="input" placeholder="ì˜ˆ: 12000"/>
              </label>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>ì¹´í…Œê³ ë¦¬
                <select id="expense-category" class="select">
                  <option value="ì‹ë¹„">ì‹ë¹„</option>
                  <option value="ì¹´í˜/ê°„ì‹">ì¹´í˜/ê°„ì‹</option>
                  <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                  <option value="êµí†µë¹„">êµí†µë¹„</option>
                  <option value="ë¬¸í™”/ì—¬ê°€">ë¬¸í™”/ì—¬ê°€</option>
                  <option value="ìƒí™œ/ê¸°íƒ€">ìƒí™œ/ê¸°íƒ€</option>
                  <option value="ê±´ê°•/ìš´ë™">ê±´ê°•/ìš´ë™</option>
                  <option value="ë·°í‹°/í—¤ì–´">ë·°í‹°/í—¤ì–´</option>
                </select>
              </label>
            </div>
            <div class="col">
              <label>ë©”ëª¨
                <input id="expense-memo" class="input" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸"/>
              </label>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
            <button class="btn" id="btn-save-expense" type="button">ì§€ì¶œ ì €ì¥</button>
            <button class="btn ghost" id="btn-refresh-expense" type="button">í˜„ì¬ ë‹¬ ì§€ì¶œ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card tile">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2>ë‹¬ë³„ ì§€ì¶œ ë‚´ì—­</h2>
            <input type="month" id="expense-list-month" class="input" style="max-width:150px"/>
          </div>
          <table style="margin-top:8px">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ë©”ëª¨</th>
                <th style="text-align:right;">ê¸ˆì•¡</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="expense-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ë‹¬ë ¥ í˜ì´ì§€ -->
  <section id="page-calendar" class="page">
    <div class="card tile">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <h2 style="margin:0">ì§€ì¶œ ë‹¬ë ¥</h2>
        <div class="row" style="align-items:center;gap:6px">
          <button class="btn ghost" id="prevMonth" type="button">â—€ï¸</button>
          <strong id="calTitle" style="min-width:150px;text-align:center"></strong>
          <button class="btn ghost" id="nextMonth" type="button">â–¶ï¸</button>
          <select id="jumpMonth" class="select" style="width:140px"></select>
        </div>
      </div>
      <p class="muted" style="margin-top:6px">
        ê° ë‚ ì§œë³„ë¡œ í•´ë‹¹ ì›” ì§€ì¶œ í•©ê³„ê°€ í‘œì‹œë˜ê³ , ê°€ì¥ ë§ì´ ì“´ ë‚  / ê°€ì¥ ì ê²Œ ì“´ ë‚ ì´ ê°•ì¡°ë©ë‹ˆë‹¤.
      </p>
      <div class="calendar" id="calendarGrid"></div>
    </div>
  </section>

  <!-- í†µê³„ í˜ì´ì§€ -->
  <section id="page-stats" class="page">
    <div class="card tile">
      <h2>ìµœê·¼ 12ê°œì›” ì›”ë³„ ì§€ì¶œ (ì„  ê·¸ë˜í”„)</h2>
      <canvas id="lineChart" width="800" height="260"></canvas>
    </div>
    <div class="card tile" style="margin-top:16px">
      <h2>ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ (í˜„ì¬ ê¸°ì¤€ ì›”)</h2>
      <div id="categoryBars" class="row"></div>
    </div>
  </section>

  <!-- ê°•ì•„ì§€ í˜ì´ì§€ -->
  <section id="page-dog" class="page">
    <div class="dog-card">
      <div class="dog-left card">
        <div class="dog-img float" id="dogImg" aria-label="ê°•ì•„ì§€"></div>
        <div class="bone">ğŸ¦´ <span id="boneCount">0</span></div>
      </div>
      <div class="dog-right card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div class="level-pill">
            ì´ë¦„: <strong id="dogTierName">ê±°ì§€ê°•ì•„ì§€</strong> Â· <span id="dogLevel">Lv.1</span>
          </div>
          <div class="pill">ë³´ìœ  ë¼ˆë‹¤ê·€: <strong id="boneCount2">0</strong></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px">
            <span>ë ˆë²¨ ì§„í–‰ë„</span>
            <span class="muted" style="font-size:11px">(1ë‹¨ê³„ 30ê°œ, 2ë‹¨ê³„ 60ê°œ, 3ë‹¨ê³„ 90ê°œ, 4ë‹¨ê³„ 150ê°œ, 5ë‹¨ê³„ 200ê°œ)</span>
          </div>
          <div class="progress"><span id="dogProgress" style="width:0%"></span></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button class="btn" id="dailyCheck" type="button">ì¶œì„í•˜ê¸°: ğŸ¦´ 1</button>
          <span class="muted" id="checkInfo" style="font-size:12px"></span>
        </div>
        <div class="actions" style="margin-top:10px">
          <button data-cost="1" data-action="pet">ì“°ë‹¤ë“¬ê¸° (ğŸ¦´1)</button>
          <button data-cost="3" data-action="play">ë†€ì•„ì£¼ê¸° (ğŸ¦´3)</button>
          <button data-cost="5" data-action="feed">ë°¥ì£¼ê¸° (ğŸ¦´5)</button>
        </div>
        <div id="dogEmojis" style="min-height:40px;margin-top:10px"></div>
      </div>
    </div>
  </section>
  <!-- ì†Œë¹„ì „ëµ í˜ì´ì§€ -->
  <section id="page-strategy" class="page">
    <div class="card tile">
      <h2>ğŸ’¡ AI ì†Œë¹„ ì „ëµ ë¶„ì„</h2>
      <p class="muted">OpenAIê°€ ë‹¹ì‹ ì˜ ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ë§ì¶¤ ì „ëµì„ ì œì•ˆí•´ë“œë ¤ìš”.</p>
      <button class="btn" id="btn-generate-strategy" style="margin-top:12px">
        ğŸ¤– AI ì „ëµ ìƒì„±í•˜ê¸°
      </button>
    </div>

    <div class="card tile" style="margin-top:16px;display:none" id="strategy-result">
      <h3>ğŸ“Š ì´ë²ˆ ë‹¬ ë¶„ì„ ê²°ê³¼</h3>
      <div id="strategy-analysis" style="margin-top:12px">
        <div style="padding:12px;background:var(--y-50);border-radius:8px;margin-bottom:8px">
          <strong>ì´ ì§€ì¶œ:</strong> <span id="strategy-total">0ì›</span>
        </div>
        <div style="padding:12px;background:var(--y-50);border-radius:8px;margin-bottom:8px">
          <strong>ê°€ì¥ ë§ì´ ì“´ ì¹´í…Œê³ ë¦¬:</strong> <span id="strategy-top-category">-</span>
        </div>
        <div style="padding:12px;background:var(--y-50);border-radius:8px">
          <strong>ì˜ˆì‚° ëŒ€ë¹„ ì§€ì¶œ:</strong> <span id="strategy-budget-ratio">-%</span>
        </div>
      </div>

      <h3 style="margin-top:24px">ğŸ’¬ AI ì¶”ì²œ ì „ëµ</h3>
      <div id="ai-strategy-content" style="margin-top:12px;padding:16px;background:var(--y-50);border-radius:12px;border:1px solid var(--line);white-space:pre-line;line-height:1.8">
        AIê°€ ì „ëµì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...
      </div>
    </div>
  </section>

</main>

<div id="toast" class="toast"></div>

<script>

/*********************** ê°•ì•„ì§€ ì´ë¯¸ì§€ ê²½ë¡œ ***********************/
const dogImages = {
	 1: '/img/dog_lv1.png',
	 2: '/img/dog_lv2.png',
	 3: '/img/dog_lv3.png',
	 4: '/img/dog_lv4.png',
	 5: '/img/dog_lv5.png'
};
/* ===== ê³µí†µ ìœ í‹¸ ===== */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

let currentUser = null;            // {id, username, ...}
let currentYearMonth = null;       // "YYYY-MM"
let currentExpenses = [];          // í˜„ì¬ ê¸°ì¤€ ì›” ì§€ì¶œ(ë°±ì—”ë“œ)
let currentBudgetTotal = 0;
let rate = 900;                    // í‘œì‹œìš© í™˜ìœ¨ (í”„ë¡ íŠ¸ ì „ìš©)

/* ===== í† ìŠ¤íŠ¸ ===== */
function showToast(msg){
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

/* ===== ë‚ ì§œ í—¬í¼ ===== */
function getTodayYearMonth(){
  return new Date().toISOString().slice(0,7); // YYYY-MM
}
function monthKey(d){
  const dt = (typeof d==='string') ? new Date(d) : d;
  return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
}
function parseYearMonth(ym){
  if(!ym || ym.length!==7) return null;
  const [y,m] = ym.split('-').map(n=>parseInt(n,10));
  return {year:y, month:m};
}
function formatCurrency(v){
  if(v==null || isNaN(v)) return '0ì›';
  return Number(v).toLocaleString('ko-KR') + 'ì›';
}

/* ===== í˜ì´ì§€ ì „í™˜ ===== */
const pages = ['page-auth','page-main','page-budget','page-expense','page-calendar','page-stats','page-dog'];
function go(id){
  pages.forEach(pid=>{
    const el = document.getElementById(pid);
    el.classList.toggle('active', pid===id);
  });
}

/* ===== í—¤ë” / ì•„ë°”íƒ€ / ë©”ë‰´ ===== */
const menuSheet = $('#menuSheet');
$('#openMenu').addEventListener('click',()=>{
  menuSheet.classList.toggle('active');
});
$('#menuSheet').addEventListener('click',(e)=>{
  if(e.target.matches('[data-close]')){
    menuSheet.classList.remove('active');
  }
});
$$('#menuSheet [data-nav]').forEach(btn=>{
  btn.addEventListener('click',(e)=>{
    const target = e.currentTarget.getAttribute('data-nav');
    menuSheet.classList.remove('active');
    go(target);
    if(target==='page-calendar') renderCalendar();
    if(target==='page-stats'){ drawLine(); renderCategoryBars(); }
	
	// â­â­â­ ê°•ì•„ì§€ í˜ì´ì§€ ë“¤ì–´ê°ˆ ë•Œ ê°•ì œ ê°±ì‹ !!
	if(target === 'page-dog'){
	   loadDog();
	   updateDogUI();
	 }
  });
});

$('#avatarBtn').addEventListener('click',()=>{
  $('#avatarDropdown').classList.toggle('hidden');
});
window.addEventListener('click',(e)=>{
  if(!$('#avatarBtn').contains(e.target) && !$('#avatarDropdown').contains(e.target)){
    $('#avatarDropdown').classList.add('hidden');
  }
});

/* í™˜ìœ¨ í† ê¸€(í‘œì‹œìš©) */
/* í™˜ìœ¨ í† ê¸€(ì‹¤ì‹œê°„ API ì—°ë™) */

const currencyToggle = $('#currencyToggle');

// ì‹¤ì‹œê°„ í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° (ë°±ì—”ë“œë¥¼ í†µí•´ í˜¸ì¶œ)
async function fetchExchangeRate(){
  try {
    const response = await fetch('/api/exchange/rate/aud');
    
    if (!response.ok) {
      throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
    }
    
    const data = await response.json();
    rate = data.rate;
    $('#rateLabel').textContent = `1 AUD = ${Math.round(rate)} KRW`;
    showToast('ì‹¤ì‹œê°„ í™˜ìœ¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    
  } catch(err) {
    console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', err);
    showToast('í™˜ìœ¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”. ê¸°ë³¸ê°’(900)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
    rate = 900;
    $('#rateLabel').textContent = `1 AUD = ${rate} KRW`;
  }
}

function fmtDisplay(amountKRW){
  if(currencyToggle.checked){
    const aud = amountKRW / rate;
    return new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(aud);
  }
  return formatCurrency(amountKRW);
}

currencyToggle.addEventListener('change', async ()=>{
  const rateLabel = document.getElementById('rateLabel').parentElement; // í™˜ìœ¨ ë©˜íŠ¸ ì „ì²´ div
  
  if(currencyToggle.checked){
    await fetchExchangeRate();
    rateLabel.style.display = 'block'; // ë³´ì´ê¸°
  } else {
    rateLabel.style.display = 'none'; // ìˆ¨ê¸°ê¸°
  }
  
  updateMainView();
  drawPie();
  drawLine();
  renderCategoryBars();
  renderExpenseTable();
});

$('#rateLabel').addEventListener('click', async ()=>{
  await fetchExchangeRate();
  if(currencyToggle.checked){
    updateMainView();
    drawPie();
    drawLine();
    renderCategoryBars();
    renderExpenseTable();
  }
});
async function fetchExchangeRate(){
  try {
    console.log('í™˜ìœ¨ API í˜¸ì¶œ ì‹œì‘...');
    const response = await fetch('/api/exchange/rate/aud');
    
    if (!response.ok) {
      throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
    }
    
    const data = await response.json();
    console.log('ë°›ì€ ë°ì´í„°:', data);  // â­ ì¶”ê°€
    console.log('í™˜ìœ¨ ê°’:', data.rate);  // â­ ì¶”ê°€
    
    rate = data.rate;
    console.log('ì ìš©ëœ rate ë³€ìˆ˜:', rate);  // â­ ì¶”ê°€
    
    $('#rateLabel').textContent = `1 AUD = ${Math.round(rate)} KRW`;
    showToast('ì‹¤ì‹œê°„ í™˜ìœ¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    
  } catch(err) {
    console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', err);
    showToast('í™˜ìœ¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”. ê¸°ë³¸ê°’(900)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
    rate = 900;
    $('#rateLabel').textContent = `1 AUD = ${rate} KRW`;
  }
}

/* ===== ë¡œê·¸ì¸ / íšŒì›ê°€ì… ===== */
const loginForm = $('#login-form');
const registerForm = $('#register-form');

$('#tab-login').addEventListener('click',()=>{
  loginForm.classList.remove('hidden');
  registerForm.classList.add('hidden');
  $('#tab-login').classList.remove('ghost');
  $('#tab-signup').classList.add('ghost');
});
$('#tab-signup').addEventListener('click',()=>{
  registerForm.classList.remove('hidden');
  loginForm.classList.add('hidden');
  $('#tab-signup').classList.remove('ghost');
  $('#tab-login').classList.add('ghost');
});

/* íšŒì›ê°€ì… */
registerForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = $('#register-name').value.trim();
  const username = $('#register-username').value.trim();
  const password = $('#register-password').value.trim();
  const age = $('#register-age').value;
  const gender = $('#register-gender').value;

  if(!username || !password){
    showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
    return;
  }

  const payload = { username, password };
  if(name)  payload.name = name;
  if(age)   payload.age = Number(age);
  if(gender) payload.gender = gender;

  try{
    const res = await fetch('/api/user/register',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error();
    const user = await res.json();
    showToast('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
    // ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ëŒë¦¬ê¸°
    $('#tab-login').click();
    $('#login-username').value = user.username || username;
  }catch(err){
    console.error(err);
    showToast('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
});

/* ë¡œê·¸ì¸ */
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = $('#login-username').value.trim();
  const password = $('#login-password').value.trim();
  if(!username || !password){
    showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try{
    const res = await fetch('/api/user/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ username, password })
    });
    if(!res.ok) throw new Error();
    const user = await res.json();
    if(!user || !user.id) throw new Error();

    currentUser = user;
    $('#headerGreeting').textContent = `${user.name || user.username}ë‹˜ í™˜ì˜í•´ìš”!`;
    // ê¸°ë³¸ ê¸°ì¤€ì›”: ì˜¤ëŠ˜
    currentYearMonth = getTodayYearMonth();
    $('#global-year-month').value = currentYearMonth;
    $('#budget-year-month').value = currentYearMonth;
    $('#expense-list-month').value = currentYearMonth;

    await loadBudget();
    await loadExpensesForCurrentMonth();

    updateMainView();
    go('page-main');
  }catch(err){
    console.error(err);
    showToast('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
});

/* ë¡œê·¸ì•„ì›ƒ */
$('#logoutBtn').addEventListener('click',()=>{
  currentUser = null;
  currentYearMonth = null;
  currentExpenses = [];
  currentBudgetTotal = 0;
  $('#headerGreeting').textContent = 'ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš” ğŸ£';
  $('#login-form').reset();
  $('#register-form').reset();
  go('page-auth');
  $('#avatarDropdown').classList.add('hidden');
  showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

/* ===== ê¸°ì¤€ ì›” ì„¤ì • (ë©”ì¸ + ì˜ˆì‚° í˜ì´ì§€) ===== */
function syncYearMonthInputs(){
  if(!currentYearMonth) return;
  $('#global-year-month').value = currentYearMonth;
  $('#budget-year-month').value = currentYearMonth;
  $('#expense-list-month').value = currentYearMonth;
}

$('#btn-set-month').addEventListener('click', async ()=>{
  const ym = $('#global-year-month').value;
  if(!ym){ showToast('ê¸°ì¤€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  currentYearMonth = ym;
  syncYearMonthInputs();
  await loadBudget();
  await loadExpensesForCurrentMonth();
  updateMainView();
  showToast('ê¸°ì¤€ ì›”ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

$('#btn-budget-set-month').addEventListener('click', async ()=>{
  const ym = $('#budget-year-month').value;
  if(!ym){ showToast('ê¸°ì¤€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  currentYearMonth = ym;
  syncYearMonthInputs();
  await loadBudget();
  await loadExpensesForCurrentMonth();
  updateMainView();
  showToast('ê¸°ì¤€ ì›”ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

/* ===== ì˜ˆì‚° API ì—°ë™ ===== */
async function loadBudget(){
  if(!currentUser || !currentYearMonth) return;
  const p = parseYearMonth(currentYearMonth);
  if(!p) return;
  const {year, month} = p;

  try{
    const res = await fetch(`/api/budget/${currentUser.id}/${year}/${month}`);
    if(!res.ok){
      // ì˜ˆì‚° ì—†ìŒ
      clearBudgetInputs();
      currentBudgetTotal = 0;
      return;
    }
    const b = await res.json();
    if(b){
      $('#budget-total').value     = b.totalBudget    ?? 0;
      $('#budget-food').value      = b.foodBudget     ?? 0;
      $('#budget-cafe').value      = b.cafeBudget     ?? 0;
      $('#budget-shopping').value  = b.shoppingBudget ?? 0;
      $('#budget-transport').value = b.transportBudget?? 0;
      $('#budget-culture').value   = b.cultureBudget  ?? 0;
      $('#budget-life').value      = b.lifeBudget     ?? 0;
      $('#budget-health').value    = b.healthBudget   ?? 0;
      $('#budget-beauty').value    = b.beautyBudget   ?? 0;
      currentBudgetTotal = b.totalBudget ?? 0;
    }else{
      clearBudgetInputs();
      currentBudgetTotal = 0;
    }
  }catch(err){
    console.error(err);
    showToast('ì˜ˆì‚° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
}
function clearBudgetInputs(){
  $('#budget-total').value     = '';
  $('#budget-food').value      = '';
  $('#budget-cafe').value      = '';
  $('#budget-shopping').value  = '';
  $('#budget-transport').value = '';
  $('#budget-culture').value   = '';
  $('#budget-life').value      = '';
  $('#budget-health').value    = '';
  $('#budget-beauty').value    = '';
}
$('#btn-save-budget').addEventListener('click', async ()=>{
  if(!currentUser){ showToast('ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.'); return; }
  if(!currentYearMonth){ showToast('ê¸°ì¤€ ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const body = {
    yearMonth: currentYearMonth,
    totalBudget: Number($('#budget-total').value || 0),
    foodBudget: Number($('#budget-food').value || 0),
    cafeBudget: Number($('#budget-cafe').value || 0),
    shoppingBudget: Number($('#budget-shopping').value || 0),
    transportBudget: Number($('#budget-transport').value || 0),
    cultureBudget: Number($('#budget-culture').value || 0),
    lifeBudget: Number($('#budget-life').value || 0),
    healthBudget: Number($('#budget-health').value || 0),
    beautyBudget: Number($('#budget-beauty').value || 0)
  };

  try{
    const res = await fetch(`/api/budget/${currentUser.id}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok) throw new Error();
    await res.json();
    currentBudgetTotal = body.totalBudget;
    updateMainView();
    showToast('ì˜ˆì‚°ì´ ì €ì¥ë˜ì—ˆì–´ìš”.');
  }catch(err){
    console.error(err);
    showToast('ì˜ˆì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
});
$('#btn-load-budget').addEventListener('click', async ()=>{
  await loadBudget();
  updateMainView();
  showToast('ì˜ˆì‚°ì„ ë¶ˆëŸ¬ì™”ì–´ìš”.');
});
$('#btn-delete-budget').addEventListener('click', async ()=>{
  if(!currentUser || !currentYearMonth){
    showToast('ë¡œê·¸ì¸ê³¼ ê¸°ì¤€ ì›” ì„ íƒì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.');
    return;
  }
  if(!confirm('í•´ë‹¹ ì›”ì˜ ì˜ˆì‚°ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  try{
    const res = await fetch(`/api/budget/${currentUser.id}/${currentYearMonth}`,{
      method:'DELETE'
    });
    if(!res.ok && res.status!==204) throw new Error();
    clearBudgetInputs();
    currentBudgetTotal = 0;
    updateMainView();
    showToast('ì˜ˆì‚°ì´ ì‚­ì œë˜ì—ˆì–´ìš”.');
  }catch(err){
    console.error(err);
    showToast('ì˜ˆì‚° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
});

/* ===== ì§€ì¶œ API ì—°ë™ ===== */
async function loadExpensesForCurrentMonth(){
  if(!currentUser || !currentYearMonth) return;
  const p = parseYearMonth(currentYearMonth);
  if(!p) return;
  const {year, month} = p;

  try{
    const res = await fetch(`/api/expense/${currentUser.id}/${year}/${month}`);
    if(!res.ok){
      currentExpenses = [];
    }else{
      currentExpenses = await res.json();
    }
    renderExpenseTable();
    updateMainView();
    drawPie();
    renderCalendar();
    drawLine();
    renderCategoryBars();
  }catch(err){
    console.error(err);
    showToast('ì§€ì¶œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
}
function renderExpenseTable(){
  const tbody = $('#expense-table-body');
  tbody.innerHTML = '';
  const ym = $('#expense-list-month').value || currentYearMonth || getTodayYearMonth();
  const rows = currentExpenses
    .filter(e=>monthKey(e.spendDate)===ym)
    .sort((a,b)=> (a.spendDate || '').localeCompare(b.spendDate || ''));

  if(rows.length===0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 5;
    td.textContent = 'ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.';
    td.style.textAlign = 'center';
    td.style.color = '#b2bec3';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(exp=>{
    const tr = document.createElement('tr');
    const dateTd = document.createElement('td');
    dateTd.textContent = exp.spendDate || '-';
    const catTd = document.createElement('td');
    catTd.textContent = exp.category || '-';
    const memoTd = document.createElement('td');
    memoTd.textContent = exp.memo || '';
    const amtTd = document.createElement('td');
    amtTd.style.textAlign = 'right';
    amtTd.textContent = fmtDisplay(exp.amount || 0);
    const actionTd = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = 'ì‚­ì œ';
    btn.className = 'btn ghost';
    btn.style.fontSize = '11px';
    btn.addEventListener('click',()=>deleteExpense(exp.id));
    actionTd.appendChild(btn);

    tr.appendChild(dateTd);
    tr.appendChild(catTd);
    tr.appendChild(memoTd);
    tr.appendChild(amtTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
}

async function deleteExpense(id){
  if(!id) return;
  if(!confirm('ì´ ì§€ì¶œ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  try{
    const res = await fetch(`/api/expense/${id}`,{ method:'DELETE' });
    if(!res.ok && res.status!==204) throw new Error();
    showToast('ì§€ì¶œ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆì–´ìš”.');
    await loadExpensesForCurrentMonth();
  }catch(err){
    console.error(err);
    showToast('ì§€ì¶œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
}

$('#expense-list-month').addEventListener('change',()=>{
  const ym = $('#expense-list-month').value;
  if(ym){
    currentYearMonth = ym;
    syncYearMonthInputs();
    loadExpensesForCurrentMonth();
  }
});

$('#btn-save-expense').addEventListener('click', async ()=>{
  if(!currentUser){ showToast('ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.'); return; }
  const date = $('#expense-date').value;
  const amount = Number($('#expense-amount').value || 0);
  const category = $('#expense-category').value;
  const memo = $('#expense-memo').value.trim();
  if(!date || !amount){
    showToast('ë‚ ì§œì™€ ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
    return;
  }
  const ym = monthKey(date);
  currentYearMonth = ym;
  syncYearMonthInputs();

  const payload = { spendDate: date, amount, category, memo };
  try{
    const res = await fetch(`/api/expense/${currentUser.id}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error();
    await res.json();
    $('#expense-amount').value = '';
    $('#expense-memo').value = '';
    showToast('ì§€ì¶œì´ ì €ì¥ë˜ì—ˆì–´ìš”.');
    await loadExpensesForCurrentMonth();
  }catch(err){
    console.error(err);
    showToast('ì§€ì¶œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
});
$('#btn-refresh-expense').addEventListener('click', async ()=>{
  await loadExpensesForCurrentMonth();
  showToast('ì§€ì¶œì„ ìƒˆë¡œê³ ì¹¨í–ˆì–´ìš”.');
});

/* ===== ë©”ì¸ KPI & íŒŒì´ì°¨íŠ¸ ===== */
function updateMainView(){
  if(!currentUser || !currentYearMonth) return;
  $('#main-username').textContent = currentUser.name || currentUser.username || 'ì‚¬ìš©ì';
  $('#main-year-month').textContent = currentYearMonth;
  $('#main-total-budget').textContent = fmtDisplay(currentBudgetTotal);

  const totalExpense = currentExpenses
    .filter(e=>monthKey(e.spendDate)===currentYearMonth)
    .reduce((sum,e)=>sum + (e.amount || 0),0);
  $('#main-expense-total').textContent = fmtDisplay(totalExpense);
}

/* íŒŒì´ì°¨íŠ¸ (í˜„ì¬ ì›” ì¹´í…Œê³ ë¦¬ë³„) */
const pieCanvas = $('#pieChart');
const pctx = pieCanvas.getContext('2d');
function sumByCategory(){
  const map = {
    'ì‹ë¹„':0,'ì¹´í˜/ê°„ì‹':0,'ì‡¼í•‘':0,'êµí†µë¹„':0,
    'ë¬¸í™”/ì—¬ê°€':0,'ìƒí™œ/ê¸°íƒ€':0,'ê±´ê°•/ìš´ë™':0,'ë·°í‹°/í—¤ì–´':0,'ê¸°íƒ€':0
  };
  currentExpenses.forEach(e=>{
    if(!e.spendDate) return;
    if(monthKey(e.spendDate)!==currentYearMonth) return;
    const cat = e.category || 'ê¸°íƒ€';
    if(!(cat in map)) map['ê¸°íƒ€'] += e.amount || 0;
    else map[cat] += e.amount || 0;
  });
  return map;
}
function drawPie(){
  const W = pieCanvas.width, H = pieCanvas.height;
  pctx.clearRect(0,0,W,H);
  if(!currentUser || !currentYearMonth) return;
  const byCat = sumByCategory();
  const entries = Object.entries(byCat).filter(([,v])=>v>0);
  if(entries.length===0){
    pctx.fillStyle='#999';
    pctx.font='14px sans-serif';
    pctx.fillText('ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 20,40);
    return;
  }
  const colors=["#FFF0A6","#FFD84D","#FFB74D","#A5D6A7","#90CAF9","#CE93D8","#F48FB1","#80CBC4","#B0BEC5"];
  const total = entries.reduce((s,[,v])=>s+v,0);
  const cx=W*0.55, cy=H*0.55, r=Math.min(W,H)/2-20;
  let start=-Math.PI/2; let i=0;
  entries.forEach(([label,val])=>{
    const angle = (val/total)*Math.PI*2;
    pctx.beginPath();
    pctx.moveTo(cx,cy);
    pctx.arc(cx,cy,r,start,start+angle);
    pctx.closePath();
    pctx.fillStyle = colors[i%colors.length];
    pctx.fill();
    start += angle;
    i++;
  });
  // legend
  pctx.font='12px sans-serif';
  let y=20; i=0;
  entries.forEach(([label,val])=>{
    pctx.fillStyle = colors[i%colors.length];
    pctx.fillRect(10,y-10,10,10);
    pctx.fillStyle = '#5A4E00';
    pctx.fillText(`${label} (${fmtDisplay(val)})`, 26,y);
    y+=16;
    i++;
  });
}

/* ===== ë‹¬ë ¥ ===== */
function renderCalendar(){
  const grid = $('#calendarGrid');
  const calTitle = $('#calTitle');
  grid.innerHTML='';
  if(!currentYearMonth){
    calTitle.textContent='-';
    return;
  }
  const {year,month} = parseYearMonth(currentYearMonth);
  calTitle.textContent = `${year}ë…„ ${month}ì›”`;

  // jumpMonth ì˜µì…˜ (ê¸°ì¤€ì›” ê¸°ì¤€ Â±6ê°œì›”)
  const jm = $('#jumpMonth');
  const base = new Date(year, month-1, 1);
  const options=[];
  for(let i=-6;i<=6;i++){
    const d=new Date(base.getFullYear(), base.getMonth()+i, 1);
    options.push(monthKey(d));
  }
  jm.innerHTML = options.map(v=>`<option ${v===currentYearMonth?'selected':''}>${v}</option>`).join('');

  const first = new Date(year,month-1,1);
  const startDay = first.getDay();
  const days = new Date(year,month,0).getDate();

  const byDay = {};
  currentExpenses.forEach(e=>{
    if(!e.spendDate) return;
    const d = new Date(e.spendDate);
    if(d.getFullYear()===year && (d.getMonth()+1)===month){
      const day = d.getDate();
      byDay[day] = (byDay[day]||0) + (e.amount || 0);
    }
  });
  const vals = Object.values(byDay);
  const max = vals.length? Math.max(...vals):0;
  const min = vals.length? Math.min(...vals):0;

  // ë¹ˆ ì…€
  for(let i=0;i<startDay;i++){
    const ph=document.createElement('div');
    ph.className='day';
    grid.append(ph);
  }

  for(let d=1; d<=days; d++){
    const el=document.createElement('div');
    el.className='day';
    const v = byDay[d]||0;
    el.innerHTML = `
      <div class="date">${d}</div>
      <div class="badge" style="margin-top:auto">${v>0? '-'+fmtDisplay(v):'-'}</div>
      <div class="muted" style="font-size:11px;margin-top:4px">
        ${(v===max && v>0)?'<span class="badge tag-hi">ìµœë‹¤ ì†Œë¹„</span>':''}
        ${(v===min && v>0)?'<span class="badge tag-lo">ìµœì†Œ ì†Œë¹„</span>':''}
      </div>
    `;
    grid.append(el);
  }
}
$('#prevMonth').addEventListener('click', async ()=>{
  if(!currentYearMonth) currentYearMonth = getTodayYearMonth();
  const {year,month} = parseYearMonth(currentYearMonth);
  const d = new Date(year,month-2,1); // -1month
  currentYearMonth = monthKey(d);
  syncYearMonthInputs();
  await loadExpensesForCurrentMonth();
});
$('#nextMonth').addEventListener('click', async ()=>{
  if(!currentYearMonth) currentYearMonth = getTodayYearMonth();
  const {year,month} = parseYearMonth(currentYearMonth);
  const d = new Date(year,month,1); // +1month
  currentYearMonth = monthKey(d);
  syncYearMonthInputs();
  await loadExpensesForCurrentMonth();
});
$('#jumpMonth').addEventListener('change', async (e)=>{
  const ym = e.target.value;
  if(!ym) return;
  currentYearMonth = ym;
  syncYearMonthInputs();
  await loadExpensesForCurrentMonth();
});

/* ===== í†µê³„ (ìµœê·¼ 12ê°œì›”) ===== */
const lineCanvas = $('#lineChart');
const lctx = lineCanvas.getContext('2d');
async function fetchExpensesFor12Months(){
  if(!currentUser) return [];
  const now = new Date();
  const list = [];
  for(let i=11;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const ym = monthKey(d);
    const {year,month} = parseYearMonth(ym);
    try{
      const res = await fetch(`/api/expense/${currentUser.id}/${year}/${month}`);
      if(!res.ok){ list.push({ym, sum:0}); }
      else{
        const arr = await res.json();
        const sum = arr.reduce((s,e)=>s+(e.amount||0),0);
        list.push({ym,sum});
      }
    }catch{
      list.push({ym,sum:0});
    }
  }
  return list;
}
async function drawLine(){
  if(!currentUser) return;
  const W=lineCanvas.width, H=lineCanvas.height;
  lctx.clearRect(0,0,W,H);
  const data = await fetchExpensesFor12Months();
  if(!data.length) return;
  const max = Math.max(1, ...data.map(d=>d.sum));
  const pad=40;

  // grid
  lctx.strokeStyle='#E7DFA8';
  lctx.lineWidth=1;
  lctx.beginPath();
  for(let i=0;i<=4;i++){
    const y=pad + (H-2*pad)*i/4;
    lctx.moveTo(pad,y);
    lctx.lineTo(W-pad,y);
  }
  lctx.stroke();

  // polyline
  lctx.strokeStyle='#CC9A00';
  lctx.lineWidth=2;
  lctx.beginPath();
  data.forEach((d,i)=>{
    const x = pad + (W-2*pad)*i/(data.length-1);
    const y = H-pad - (H-2*pad)*(d.sum/max);
    if(i===0) lctx.moveTo(x,y); else lctx.lineTo(x,y);
  });
  lctx.stroke();

  // points
  lctx.fillStyle='#FFC93A';
  data.forEach((d,i)=>{
    const x = pad + (W-2*pad)*i/(data.length-1);
    const y = H-pad - (H-2*pad)*(d.sum/max);
    lctx.beginPath();
    lctx.arc(x,y,3,0,Math.PI*2);
    lctx.fill();
  });

  // labels
  lctx.fillStyle='#5A4E00';
  lctx.font='11px sans-serif';
  data.forEach((d,i)=>{
    const x = pad + (W-2*pad)*i/(data.length-1);
    lctx.fillText(d.ym, x-22, H-10);
  });
}

/* ì¹´í…Œê³ ë¦¬ ë°” */
function renderCategoryBars(){
  const wrap = $('#categoryBars');
  wrap.innerHTML='';
  if(!currentUser || !currentYearMonth) return;
  const byCat = sumByCategory();
  Object.entries(byCat).forEach(([cat,spent])=>{
    const card = document.createElement('div');
    card.className='col card';
    card.style.padding='10px';
    const totalCatBudget = (()=>{
      switch(cat){
        case 'ì‹ë¹„': return Number($('#budget-food').value || 0);
        case 'ì¹´í˜/ê°„ì‹': return Number($('#budget-cafe').value || 0);
        case 'ì‡¼í•‘': return Number($('#budget-shopping').value || 0);
        case 'êµí†µë¹„': return Number($('#budget-transport').value || 0);
        case 'ë¬¸í™”/ì—¬ê°€': return Number($('#budget-culture').value || 0);
        case 'ìƒí™œ/ê¸°íƒ€': return Number($('#budget-life').value || 0);
        case 'ê±´ê°•/ìš´ë™': return Number($('#budget-health').value || 0);
        case 'ë·°í‹°/í—¤ì–´': return Number($('#budget-beauty').value || 0);
        default: return 0;
      }
    })();
    const pct = totalCatBudget ? Math.min(100, Math.round(spent/totalCatBudget*100)) : 0;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${cat}</strong>
        <span class="muted">${fmtDisplay(spent)} / ${fmtDisplay(totalCatBudget)}</span>
      </div>
      <div class="progress" style="margin-top:6px"><span style="width:${pct}%"></span></div>
      <div class="muted" style="font-size:12px;margin-top:4px">${pct}% ì‚¬ìš©</div>
    `;
    wrap.append(card);
  });
}

/* ===== ê°•ì•„ì§€(ë¡œì»¬ ì €ì¥) ===== */
const tiers = [
  {name:'ê±°ì§€ê°•ì•„ì§€', need:30},
  {name:'ì„œë¯¼ê°•ì•„ì§€', need:60},
  {name:'ì¤‘ì‚°ì¸µê°•ì•„ì§€', need:90},
  {name:'ë¶€ìê°•ì•„ì§€', need:150},
  {name:'ê°œë¶€ìê°•ì•„ì§€', need:200}
];
let dogState = { bones:0, level:1, xp:0, lastCheck:'' };

function loadDog(){
  if(!currentUser) return;
  const raw = localStorage.getItem('dog:'+currentUser.username);
  if(!raw) return;
  try{
    dogState = JSON.parse(raw);
  }catch{}
}
function saveDog(){
  if(!currentUser) return;
  localStorage.setItem('dog:'+currentUser.username, JSON.stringify(dogState));
}
function updateDogUI(){
  $('#boneCount').textContent = dogState.bones;
  $('#boneCount2').textContent = dogState.bones;
  const t = tiers[dogState.level-1] || tiers[0];
  $('#dogTierName').textContent = t.name;
  $('#dogLevel').textContent = 'Lv.'+dogState.level;
  const pct = Math.min(100, Math.round(dogState.xp / t.need * 100));
  $('#dogProgress').style.width = pct + '%';
  
  // â­â­ ê°•ì•„ì§€ ì´ë¯¸ì§€ ì ìš© (ì—¬ê¸° ì¶”ê°€!)
  const imgPath = dogImages[dogState.level] || dogImages[1];
  const dogImgEl = document.getElementById('dogImg');
  dogImgEl.style.backgroundImage = `url('${imgPath}')`;
  dogImgEl.style.backgroundSize = 'cover';
  dogImgEl.style.backgroundPosition = 'center';
}
function addEmojis(type){
  const box = $('#dogEmojis');
  box.innerHTML='';
  const map={pet:['ğŸ¤š','â¤ï¸'], play:['âš½ï¸','â¤ï¸'], feed:['ğŸ–','â¤ï¸']};
  (map[type]||['â¤ï¸']).forEach((em,i)=>{
    const span=document.createElement('span');
    span.textContent=em;
    span.style.fontSize='28px';
    span.style.display='inline-block';
    span.style.opacity='0';
    span.style.transition='transform .5s, opacity .5s';
    span.style.marginRight='4px';
    box.append(span);
    setTimeout(()=>{ span.style.opacity='1'; span.style.transform='translateY(-6px)'; }, i*100);
  });
}
$('#dailyCheck').addEventListener('click',()=>{
  if(!currentUser){ showToast('ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
  const today = new Date().toISOString().slice(0,10);
  if(dogState.lastCheck===today){
    showToast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆì–´ìš”!');
    return;
  }
  dogState.lastCheck=today;
  dogState.bones+=1;
  $('#checkInfo').textContent='ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ! (+ğŸ¦´1)';
  saveDog();
  updateDogUI();
});
$$('.actions button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(!currentUser){ showToast('ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
    const cost = Number(btn.dataset.cost || 0);
    const action = btn.dataset.action;
    if(dogState.bones < cost){
      showToast('ë¼ˆë‹¤ê·€ê°€ ë¶€ì¡±í•´ìš”!');
      return;
    }
    dogState.bones -= cost;
    dogState.xp += cost;
    const t = tiers[dogState.level-1];
    if(dogState.xp >= t.need && dogState.level < 5){
      dogState.level++;
      dogState.xp = 0;
      alert('ë ˆë²¨ ì—…! ' + tiers[dogState.level-1].name + 'ê°€ ë˜ì—ˆì–´ìš”!');
    }
    addEmojis(action);
    saveDog();
    updateDogUI();
  });
});

/* ===== ì´ˆê¸°í™” ===== */
window.addEventListener('load',()=>{
  // ê¸°ë³¸: ë¡œê·¸ì¸ í˜ì´ì§€
  go('page-auth');
  $('#rateLabel').textContent = `1 AUD = ${rate} KRW`;
});
/* ===== AI ì†Œë¹„ì „ëµ ===== */
$('#btn-generate-strategy').addEventListener('click', async () => {
  if (!currentUser) {
    showToast('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
  if (!currentYearMonth) {
    showToast('ê¸°ì¤€ ì›”ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }

  const btn = $('#btn-generate-strategy');
  const resultSection = $('#strategy-result');
  
  btn.disabled = true;
  btn.textContent = 'ğŸ¤– AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
  resultSection.style.display = 'none';

  try {
    updateStrategyAnalysis();

    const [year, month] = currentYearMonth.split('-').map(Number);
    const response = await fetch(
      `/api/strategy/${currentUser.id}/${year}/${month}?budget=${currentBudgetTotal}`
    );

    if (!response.ok) {
      throw new Error('AI ì „ëµ ìƒì„± ì‹¤íŒ¨');
    }

    const data = await response.json();
    
    resultSection.style.display = 'block';
    $('#ai-strategy-content').textContent = data.strategy;
    
    showToast('AI ì „ëµì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');

  } catch (error) {
    console.error('AI ì „ëµ ìƒì„± ì˜¤ë¥˜:', error);
    showToast('AI ì „ëµ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    $('#ai-strategy-content').textContent = 
      'âš ï¸ ì „ëµ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' +
      'âœ… ì§€ì¶œ ë‚´ì—­ì„ ê¾¸ì¤€íˆ ê¸°ë¡í•˜ì„¸ìš”.\n' +
      'ğŸ’¡ ì˜ˆì‚°ì„ ì„¤ì •í•˜ê³  ê´€ë¦¬í•´ë³´ì„¸ìš”.';
    resultSection.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ¤– AI ì „ëµ ì¬ìƒì„±í•˜ê¸°';
  }
});

function updateStrategyAnalysis() {
  if (!currentUser || !currentYearMonth) return;

  const total = currentExpenses
    .filter(e => monthKey(e.spendDate) === currentYearMonth)
    .reduce((sum, e) => sum + (e.amount || 0), 0);
  $('#strategy-total').textContent = fmtDisplay(total);

  const byCat = {};
  currentExpenses.forEach(e => {
    if (monthKey(e.spendDate) === currentYearMonth) {
      const cat = e.category || 'ê¸°íƒ€';
      byCat[cat] = (byCat[cat] || 0) + (e.amount || 0);
    }
  });

  let maxCat = '-';
  let maxAmt = 0;
  Object.entries(byCat).forEach(([cat, amt]) => {
    if (amt > maxAmt) {
      maxCat = cat;
      maxAmt = amt;
    }
  });
  
  if (maxCat !== '-') {
    $('#strategy-top-category').textContent = maxCat + ' (' + fmtDisplay(maxAmt) + ')';
  } else {
    $('#strategy-top-category').textContent = 'ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ì–´ìš”';
  }

  const ratio = currentBudgetTotal ? Math.round((total / currentBudgetTotal) * 100) : 0;
  $('#strategy-budget-ratio').textContent = ratio + '%';
}
</script>

</body>
</html>
